# -*- coding: utf-8 -*-
"""
新手引导工具
提供首次使用引导和交互式教程功能
"""

import streamlit as st
import json
import os


def check_first_run():
    """检查是否首次运行"""
    if 'first_run_completed' not in st.session_state:
        st.session_state.first_run_completed = False

    # 检查是否有数据
    try:
        from utils.db_helper import get_db_info
        db_info = get_db_info()

        # 如果已经有数据，不算首次运行
        if db_info.get('stock_pool_count', 0) > 0:
            st.session_state.first_run_completed = True

    except:
        pass

    return not st.session_state.first_run_completed


def mark_first_run_completed():
    """标记首次运行完成"""
    st.session_state.first_run_completed = True


def render_welcome_modal():
    """渲染欢迎弹窗"""

    with st.expander("🎉 欢迎使用股票量化选股系统！", expanded=True):
        st.markdown("""
        ### 🌟 新手友好，3步开始选股

        这是一个专为股市新手设计的量化选股工具，无需编程知识，通过简单的Web界面即可完成选股。

        ---
        """)

        # 三步教程
        step1, step2, step3 = st.columns(3)

        with step1:
            st.markdown("""
            <div style="text-align: center; padding: 1rem; background: #e3f2fd; border-radius: 0.5rem; margin: 0.5rem 0;">
                <h3>1️⃣ 下载数据</h3>
                <p style="font-size: 0.9rem;">在"数据管理"页面添加股票并下载历史数据</p>
            </div>
            """, unsafe_allow_html=True)

        with step2:
            st.markdown("""
            <div style="text-align: center; padding: 1rem; background: #e8f5e9; border-radius: 0.5rem; margin: 0.5rem 0;">
                <h3>2️⃣ 配置策略</h3>
                <p style="font-size: 0.9rem;">在"策略配置"页面选择或创建选股策略</p>
            </div>
            """, unsafe_allow_html=True)

        with step3:
            st.markdown("""
            <div style="text-align: center; padding: 1rem; background: #fff3e0; border-radius: 0.5rem; margin: 0.5rem 0;">
                <h3>3️⃣ 执行选股</h3>
                <p style="font-size: 0.9rem;">在"执行选股"页面一键筛选符合条件的股票</p>
            </div>
            """, unsafe_allow_html=True)

        st.markdown("---")

        # 核心功能介绍
        st.markdown("### 📚 核心功能介绍")

        col1, col2 = st.columns(2)

        with col1:
            st.markdown("""
            **📊 数据管理**
            - 自动下载股票数据（支持多周期）
            - 增量更新功能
            - 数据质量检查

            **📈 技术指标**
            - 自动计算常用技术指标
            - K线图和指标图展示
            - 指标数据查询和导出
            """)

        with col2:
            st.markdown("""
            **⚙️ 策略配置**
            - 16种经典策略模板
            - 可视化参数调整
            - 保存自定义策略

            **🎯 智能选股**
            - 一键执行选股
            - 结果可视化展示
            - 历史记录对比

            **🔔 实时监控**
            - 价格和指标监控
            - 自动触发提醒
            """)

        st.markdown("---")

        # 快速开始按钮
        col1, col2, col3 = st.columns(3)

        with col1:
            if st.button("📊 前往数据管理", use_container_width=True):
                st.session_state.page = '📊 数据管理'
                mark_first_run_completed()
                st.rerun()

        with col2:
            if st.button("📖 查看完整教程", use_container_width=True):
                st.session_state.show_tutorial = True
                st.rerun()

        with col3:
            if st.button("✅ 跳过引导", use_container_width=True):
                mark_first_run_completed()
                st.rerun()

        # 提示
        st.info("💡 提示：你可以随时在左侧导航栏点击'帮助文档'查看使用指南")


def render_quick_tutorial():
    """渲染快速教程"""

    st.title("📖 快速教程")

    # 创建教程标签页
    tab1, tab2, tab3, tab4, tab5 = st.tabs([
        "🚀 快速开始",
        "📊 数据管理",
        "⚙️ 策略配置",
        "🎯 执行选股",
        "🔔 实时监控"
    ])

    with tab1:
        render_tutorial_quickstart()

    with tab2:
        render_tutorial_data_manager()

    with tab3:
        render_tutorial_strategies()

    with tab4:
        render_tutorial_selector()

    with tab5:
        render_tutorial_monitor()


def render_tutorial_quickstart():
    """渲染快速开始教程"""

    st.markdown("## 🚀 5分钟快速开始")

    st.markdown("""
    本教程将带你完成从安装到第一次选股的完整流程。

    ---

    ### 📋 准备工作

    **系统要求**：
    - Python 3.10 或更高版本
    - Windows / macOS / Linux 操作系统
    - 至少 4GB 内存

    **安装步骤**：

    1. **下载项目**
       ```bash
       git clone <项目地址>
       cd stock_web_app
       ```

    2. **一键启动**

       Windows用户：
       ```batch
       start.bat
       ```

       macOS/Linux用户：
       ```bash
       chmod +x start.sh
       ./start.sh
       ```

    3. **等待初始化**
       - 首次运行会自动创建虚拟环境
       - 自动安装依赖包（约2-3分钟）
       - 自动初始化数据库

    4. **访问应用**
       - 浏览器打开：http://localhost:8501
       - 开始使用！

    ---

    ### 🎯 第一次选股（3步）

    #### 步骤1：下载数据

    1. 点击左侧导航栏的 **"📊 数据管理"**
    2. 在 **"股票池管理"** 标签页添加股票
       - 单只添加：输入股票代码（如：600519.SH）
       - 批量导入：点击"批量导入"，每行一个代码
    3. 切换到 **"数据下载"** 标签页
       - 选择日期范围（建议最近1年）
       - 选择周期（日线、60分钟等）
       - 点击"开始下载"

    #### 步骤2：配置策略

    1. 点击左侧导航栏的 **"⚙️ 策略配置"**
    2. 在 **"配置策略"** 标签页：
       - 选择策略类型（如：趋势型）
       - 选择具体策略（如：均线多头排列）
       - 调整参数（使用滑块或输入框）
    3. 点击 **"💾 保存策略"**
       - 输入策略名称
       - 添加说明（可选）
       - 确认保存

    #### 步骤3：执行选股

    1. 点击左侧导航栏的 **"🎯 执行选股"**
    2. 在 **"执行选股"** 标签页：
       - 选择刚保存的策略
       - 选择股票池（或"全部"）
       - 选择选股日期
    3. 点击 **"🎯 开始选股"**
    4. 查看结果并导出

    ---

    ### 💡 常用技巧

    **股票代码格式**：
    - 上海市场：600519.SH（贵州茅台）
    - 深圳市场：000001.SZ（平安银行）

    **数据周期**：
    - 日线：适合中长期分析
    - 60分钟：适合短线分析
    - 5分钟：适合日内交易

    **策略选择**：
    - 牛市：使用趋势型策略
    - 震荡市：使用突破型策略
    - 熊市：使用震荡型策略（超跌反弹）
    """)


def render_tutorial_data_manager():
    """渲染数据管理教程"""

    st.markdown("## 📊 数据管理详解")

    st.markdown("""
    数据管理模块是系统的基础，用于管理股票池和下载历史数据。

    ---

    ### 🗂️ 股票池管理

    **功能说明**：
    - 添加/删除股票
    - 股票分组管理
    - 批量导入/导出

    **操作步骤**：

    1. **添加单只股票**
       - 输入股票代码（如：600519.SH）
       - 输入股票名称（如：贵州茅台）
       - 选择分组（如：自选股）
       - 点击"添加"

    2. **批量导入**
       - 点击"批量导入"按钮
       - 每行输入一只股票：`代码 名称`
       - 例如：
         ```
         600519.SH 贵州茅台
         000858.SZ 五粮液
         600036.SH 招商银行
         ```
       - 点击"确认导入"

    3. **管理股票池**
       - 查看已添加的股票列表
       - 点击"删除"按钮移除股票
       - 使用搜索功能快速查找

    ---

    ### 📥 数据下载

    **功能说明**：
    - 支持多周期数据下载
    - 批量下载多只股票
    - 进度显示和断点续传

    **操作步骤**：

    1. **选择股票**
       - 勾选要下载的股票
       - 或点击"全选"

    2. **设置参数**
       - 开始日期：建议至少1年前
       - 结束日期：默认今天
       - 数据周期：
         - 日线（d）：最常用
         - 60分钟（60m）：短线分析
         - 30分钟（30m）
         - 15分钟（15m）
         - 5分钟（5m）：日内交易

    3. **开始下载**
       - 点击"开始下载"按钮
       - 查看进度条
       - 等待完成

    **注意事项**：
    - 首次下载建议先下载少量股票测试
    - 分钟级数据量大，建议选择性下载
    - 下载速度取决于网络和baostock服务器

    ---

    ### 🔄 数据更新

    **功能说明**：
    - 增量更新最新数据
    - 自动检测缺失日期
    - 一键更新所有股票

    **操作步骤**：

    1. 切换到"数据更新"标签页
    2. 选择要更新的股票
    3. 点击"开始更新"
    4. 等待完成

    **建议**：
    - 每天收盘后更新一次
    - 保持数据最新以保证选股准确

    ---

    ### 🔍 数据查询

    **功能说明**：
    - 查看已下载的数据
    - 检查数据完整性
    - 导出数据到Excel

    **操作步骤**：

    1. 选择股票代码
    2. 选择日期范围
    3. 点击"查询"
    4. 查看结果或导出

    **数据质量检查**：
    - 检查缺失值
    - 检查异常值
    - 生成完整性报告
    """)


def render_tutorial_strategies():
    """渲染策略配置教程"""

    st.markdown("## ⚙️ 策略配置详解")

    st.markdown("""
    策略配置模块是系统的核心，用于创建和管理选股策略。

    ---

    ### 📝 配置策略

    **策略类型**：

    1. **📈 趋势型策略**（4种）
       - 均线多头排列
       - MACD金叉
       - 回踩均线
       - 趋势跟踪

       适用场景：牛市或明确上升趋势

    2. **🚀 突破型策略**（6种）
       - 箱体突破
       - 放量突破
       - 连续上涨
       - 布林带突破
       - 缩量后放量
       - 涨停板

       适用场景：震荡市场，捕捉突破

    3. **📉 震荡型策略**（6种）
       - KDJ低位金叉
       - KDJ任意金叉
       - RSI超卖
       - RSI低位
       - 双超卖
       - 布林带下轨

       适用场景：熊市或震荡市场

    **配置步骤**：

    1. **选择策略类型**
       - 根据市场环境选择
       - 查看适用场景说明

    2. **选择具体策略**
       - 阅读策略描述
       - 了解风险等级
       - 查看参数说明

    3. **调整参数**
       - 使用滑块调整数值
       - 参考默认值和推荐值
       - 实时预览SQL条件

    4. **保存策略**
       - 输入策略名称
       - 添加说明（可选）
       - 点击保存

    ---

    ### 💾 我的策略

    **功能说明**：
    - 查看已保存的策略
    - 编辑/复制/删除策略
   - 启用/禁用策略

    **操作说明**：

    1. **查看策略**
       - 点击展开策略详情
       - 查看参数配置
       - 查看策略说明

    2. **编辑策略**
       - 点击"编辑"按钮
       - 修改参数
       - 保存修改

    3. **复制策略**
       - 点击"复制"按钮
       - 基于原策略创建副本
       - 修改后保存为新策略

    4. **删除策略**
       - 点击"删除"按钮
       - 二次确认后删除

    ---

    ### 📋 策略说明

    **参数调整建议**：

    **激进型配置**：
    - 放宽条件限制
    - 提高触发概率
    - 风险较高，收益潜力大

    **保守型配置**：
    - 严格条件限制
    - 降低触发概率
    - 风险较低，胜率较高

    **使用技巧**：

    1. **组合使用**
       - 不同市场环境使用不同策略
       - 同时配置多个策略对比

    2. **参数优化**
       - 根据历史数据回测优化
       - 记录有效参数组合

    3. **风险控制**
       - 严格执行止损
       - 控制单只股票仓位
    """)


def render_tutorial_selector():
    """渲染选股执行教程"""

    st.markdown("## 🎯 执行选股详解")

    st.markdown("""
    选股执行模块用于运行策略并查看结果。

    ---

    ### ⚡ 执行选股

    **操作步骤**：

    1. **选择策略**
       - 从下拉列表选择已保存的策略
       - 查看策略信息（类型、模板、说明）

    2. **选择股票池**
       - 全部：所有股票
       - 或选择特定分组

    3. **选择日期**
       - 选择要选股的日期
       - 默认为今天

    4. **预览条件**（可选）
       - 点击"预览条件"
       - 查看生成的SQL
       - 了解筛选逻辑

    5. **开始选股**
       - 点击"开始选股"按钮
       - 等待执行完成
       - 查看结果统计

    **结果说明**：

    - **候选股票**：筛选范围内的股票总数
    - **选出股票**：符合策略条件的股票数
    - **选出率**：选出股票占比
    - **执行耗时**：选股所用时间

    ---

    ### 📊 历史记录

    **功能说明**：
    - 查看历史选股记录
    - 查看详细结果
    - 导出历史数据

    **操作步骤**：

    1. 查看记录列表
    2. 点击展开查看详情
    3. 点击"查看详情"查看完整结果
    4. 导出为CSV

    ---

    ### 📋 结果对比

    **功能说明**：
    - 对比不同策略的选股结果
    - 查看多次选股的重叠股票
    - 分析策略稳定性

    **操作步骤**：

    1. 选择至少2条历史记录
    2. 查看对比结果
    3. 分析重叠股票
    4. 导出对比数据

    **对比指标**：
    - 对比记录数
    - 涉及股票数
    - 总选股数
    - 多次被选中的股票

    ---

    ### 💡 使用建议

    **选股频率**：
    - 日线数据：每天选一次
    - 分钟线：可多次选股

    **结果分析**：
    - 关注选出率（过高可能条件过松）
    - 对比不同策略结果
    - 观察历史表现

    **风险提醒**：
    - 选股结果仅供参考
    - 需结合其他分析
    - 注意控制风险
    """)


def render_tutorial_monitor():
    """渲染实时监控教程"""

    st.markdown("## 🔔 实时监控详解")

    st.markdown("""
    实时监控模块用于监控股票价格和指标变化。

    ---

    ### 📝 创建监控

    **监控条件类型**：

    1. **价格监控**
       - 价格突破：突破指定价格
       - 价格下跌：跌破指定价格
       - 涨跌幅：涨跌幅超过指定值

    2. **成交量监控**
       - 成交量异常：放量或缩量

    3. **技术指标监控**
       - MACD金叉/死叉
       - KDJ超买/超卖
       - RSI超买/超卖

    **操作步骤**：

    1. **输入基本信息**
       - 股票代码
       - 监控名称

    2. **选择监控类型**
       - 从下拉列表选择
       - 查看类型说明

    3. **设置参数**
       - 根据类型输入参数
       - 设置检查频率

    4. **启用监控**
       - 点击"创建监控"
       - 自动开始检查

    ---

    ### 📊 监控列表

    **功能说明**：
    - 查看所有监控任务
    - 实时更新价格
    - 查看触发次数

    **状态说明**：
    - ✅ 启用：正在监控
    - ❌ 禁用：已暂停

    **操作**：
    - 启用/禁用监控
    - 编辑监控条件
    - 删除监控

    ---

    ### 🔔 提醒历史

    **功能说明**：
    - 查看所有触发提醒
    - 标记为已读
    - 查看提醒详情

    **提醒内容**：
    - 股票代码
    - 触发条件
    - 触发时间
    - 当前价格/指标值

    ---

    ### 💡 使用技巧

    **监控设置建议**：

    1. **价格突破**
       - 设置关键阻力位
       - 设置前期高点

    2. **技术指标**
       - MACD金叉：买入信号
       - KDJ超卖：反弹机会
       - RSI超买：注意风险

    3. **检查频率**
       - 日线：每天检查一次
       - 实时：设置较短间隔

    **注意事项**：
    - 监控基于历史数据
    - 实际价格可能有延迟
    - 结合其他分析工具
    """)


def render_context_help(page_name):
    """根据页面渲染上下文帮助"""

    help_texts = {
        '📊 数据管理': """
        **💡 数据管理小贴士**

        - 股票代码格式：上海市场使用.SH后缀（如600519.SH），深圳市场使用.SZ后缀（如000001.SZ）
        - 建议先下载少量股票测试，确保正常后再批量下载
        - 每天收盘后更新数据，保持数据最新
        - 使用数据质量检查功能确保数据完整性
        """,

        '📈 技术指标': """
        **💡 技术指标小贴士**

        - MA均线：判断趋势方向，多头排列看涨
        - MACD：金叉买入，死叉卖出
        - KDJ：高于80超买，低于20超卖
        - RSI：高于70超买，低于30超卖
        - BOLL：价格触及上下轨可能反转
        """,

        '⚙️ 策略配置': """
        **💡 策略配置小贴士**

        - 牛市使用趋势型策略，顺势而为
        - 震荡市使用突破型策略，捕捉机会
        - 熊市使用震荡型策略，做超跌反弹
        - 保守策略：严格条件，低风险
        - 激进策略：宽松条件，高收益潜力
        """,

        '🎯 执行选股': """
        **💡 执行选股小贴士**

        - 选股前确保数据已更新到最新
        - 关注选出率，过高可能条件过松
        - 对比不同策略结果，选择最优
        - 定期查看历史记录，总结经验
        - 结果仅供参考，需结合其他分析
        """,

        '🔔 实时监控': """
        **💡 实时监控小贴士**

        - 设置关键价格位作为监控条件
        - 技术指标信号可作为买卖参考
        - 合理设置检查频率，避免过于频繁
        - 及时查看提醒历史，不错过机会
        """,
    }

    if page_name in help_texts:
        with st.expander("💡 页面帮助", expanded=False):
            st.markdown(help_texts[page_name])
